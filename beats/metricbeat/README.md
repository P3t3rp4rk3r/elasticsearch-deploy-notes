# Metricbeat
* Office [Docs](https://www.elastic.co/guide/en/beats/metricbeat/current/index.html)
> Collect metrics from your systems and services. From CPU to memory, Redis to NGINX, and much more, Metricbeat is a lightweight way to send system and service statistics.
## Install
* Download [Metricbeat](https://www.elastic.co/downloads/past-releases/metricbeat-7-6-2). As of now, the version is `7.6.2`
* Create directories for certificates and copy
```
$ sudo mkdir /etc/ssl/beats
## Copy .pem files to beats directory which were generated while configuring elasticsearch
$ ls /etc/ssl/beats
elasticsearch-ca.pem  letsencryptauthorityx3.pem
```

* Verify [metricbeat](./metricbeat.yml)  and copy to `/etc/journalbeat/`
```
$ ls /etc/metricbeat
fields.yml  journalbeat.reference.yml  journalbeat.yml  journalbeat.yml_backup

### If require, test config

$ metricbeat test config                                                                                                                             :(
sudo metricbeat test config
Config OK
```

* Start the daemon
```
$ sudo systemctl enable metricbeat
$ sudo systemctl start metricbeat
```

## Modules Configuration

### Postgresql module configuration
* [Docs Links](https://www.elastic.co/guide/en/beats/metricbeat/current/metricbeat-module-postgresql.html)

Create DB user and database 
```
CREATE USER elastic WITH PASSWORD 'changeme';
CREATE DATABASE elastic;
GRANT ALL PRIVILEGES ON DATABASE elastic to elastic;
ALTER USER elastic WITH SUPERUSER;
ALTER USER elastic WITH NOCREATEDB;
```
* Some metrics need super user permissions
In order to get `statement` metricset, enable [pg_stat_statements](https://www.postgresql.org/docs/9.5/pgstatstatements.html)

1. Add the following entries to your postgres.conf
```
shared_preload_libraries = 'pg_stat_statements'

# Increase the max size of the query strings Postgres records
track_activity_query_size = 2048

# Track statements generated by stored procedures as well
pg_stat_statements.track = all
```
2. Restart postgresql daemon
```
$ sudo systemctl restart postgresql
```
3. Create pg_stat_statements` extension

As the docs says
> When pg_stat_statements is loaded, it tracks statistics across all databases of the server. To access and manipulate these statistics, the module provides a view, pg_stat_statements, and the utility functions pg_stat_statements_reset and pg_stat_statements. These are not available globally but can be enabled for a specific database with CREATE EXTENSION pg_stat_statements.

You have to create `pg_stat_statements` extension in the database you what get metrics  

### Nginx module configuration
* [Docs Link](https://www.elastic.co/guide/en/beats/metricbeat/current/metricbeat-module-nginx.html)
Add below config to get nginx stats
```
location /nginx_status {
        stub_status;
        access_log   off;
        allow 127.0.0.1;        #only allow requests from localhost
        deny all;               #deny all other hosts
}
```